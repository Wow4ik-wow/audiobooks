<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Аудиокниги</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 1em;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 5px 0;
      cursor: pointer;
      background: #fff;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    li:hover {
      background: #e0f0ff;
    }
    audio {
      width: 100%;
      margin: 10px 0;
    }
    .track-list {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Поиск аудиокниг</h1>
  <input type="text" id="search" placeholder="Введите название книги...">

  <ul id="results"></ul>

  <div class="track-list hidden" id="trackList">
    <h2 id="bookTitle"></h2>
    <ul id="trackLinks"></ul>
    <audio id="player" controls></audio>
  </div>

  <script>
    const url = 'https://docs.google.com/spreadsheets/d/1_tsF4bkY20i0jyUCHvzQjwdh0PT_jJQf_Hf0NmmaLYk/gviz/tq?tqx=out:json&sheet=Лист%201';

    let books = [];

    fetch(url)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        books = rows.map(row => {
          const get = (i) => row.c[i] ? row.c[i].v : '';
          return {
            author: get(0),
            title: get(1),
            path: get(2),
            yandex: get(3),
            isCollection: get(4),
            links: [get(5), get(6), get(7)]
              .filter(Boolean)
              .flatMap(link => link.split('\n').map(x => x.trim()).filter(x => x.endsWith('.mp3')))
          };
        });

        updateSuggestions('');
      });

    const searchInput = document.getElementById('search');
    const resultsList = document.getElementById('results');
    const trackList = document.getElementById('trackList');
    const trackLinks = document.getElementById('trackLinks');
    const bookTitle = document.getElementById('bookTitle');
    const player = document.getElementById('player');

    searchInput.addEventListener('input', () => {
      updateSuggestions(searchInput.value);
    });

    function updateSuggestions(query) {
      resultsList.innerHTML = '';
      const q = query.trim().toLowerCase();
      const matches = books.filter(book => book.title.toLowerCase().includes(q));

      matches.forEach(book => {
        const li = document.createElement('li');
        li.textContent = `${book.title} — ${book.author}`;
        li.onclick = () => showBook(book);
        resultsList.appendChild(li);
      });
    }

    function showBook(book) {
      bookTitle.textContent = `${book.title} — ${book.author}`;
      trackLinks.innerHTML = '';

      book.links.forEach((link, index) => {
        const li = document.createElement('li');
        li.textContent = `Глава ${index + 1}`;
        li.onclick = () => {
          player.src = link;
          player.play();
        };
        trackLinks.appendChild(li);
      });

      // автоматическое воспроизведение следующей главы
      let current = 0;
      player.onended = () => {
        current++;
        if (current < book.links.length) {
          player.src = book.links[current];
          player.play();
        }
      };
      current = 0;
      player.src = book.links[0];
      player.play();

      trackList.classList.remove('hidden');
    }
  </script>

</body>
</html>
