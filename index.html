<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê—É–¥–∏–æ–∫–Ω–∏–≥–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f8f8f8;
    }
    h1 {
      text-align: center;
    }
    select, audio {
      width: 100%;
      margin-top: 20px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    li:hover {
      background: #eef;
    }
  </style>
</head>
<body>
  <h1>üéß –ê—É–¥–∏–æ–∫–Ω–∏–≥–∏</h1>
  <input type="text" id="search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏..." style="width:100%;padding:10px;font-size:16px"/>
  <ul id="bookList"></ul>
  <h2 id="bookTitle"></h2>
  <audio id="player" controls style="margin-top: 20px;"></audio>
  <ul id="trackList"></ul>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1_tsF4bkY20i0jyUCHvzQjwdh0PT_jJQf_Hf0NmmaLYk/gviz/tq?tqx=out:json&sheet=–õ–∏—Å—Ç%201";
    let books = [];

    fetch(sheetURL)
      .then(res => res.text())
      .then(data => {
        const json = JSON.parse(data.substring(47, data.length - 2));
        const rows = json.table.rows;
        books = rows.map(row => {
          const cells = row.c;
          return {
            author: cells[0]?.v || '',
            title: cells[1]?.v || '',
            links: [
              ...(cells[5]?.v?.split(/\s+/) || []),
              ...(cells[6]?.v?.split(/\s+/) || []),
              ...(cells[7]?.v?.split(/\s+/) || [])
            ].filter(link => link.includes(".mp3"))
          };
        }).filter(book => book.title);
        renderBookList('');
      });

    const searchInput = document.getElementById("search");
    const bookList = document.getElementById("bookList");
    const player = document.getElementById("player");
    const trackList = document.getElementById("trackList");
    const bookTitle = document.getElementById("bookTitle");

    function renderBookList(query) {
      bookList.innerHTML = '';
      const filtered = books.filter(b => b.title.toLowerCase().includes(query.toLowerCase()));
      filtered.forEach(book => {
        const li = document.createElement("li");
        li.textContent = `${book.title} ‚Äî ${book.author}`;
        li.addEventListener("click", () => playBook(book));
        bookList.appendChild(li);
      });
    }

    function playBook(book) {
      bookTitle.textContent = `${book.title} ‚Äî ${book.author}`;
      trackList.innerHTML = '';
      if (book.links.length === 0) {
        trackList.innerHTML = '<li>–ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</li>';
        player.src = '';
        return;
      }
      book.links.forEach((link, i) => {
        const li = document.createElement("li");
        li.textContent = `–ì–ª–∞–≤–∞ ${i + 1}`;
        li.addEventListener("click", () => {
          player.src = link;
          player.play();
        });
        trackList.appendChild(li);
      });
      player.src = book.links[0];
      player.play();

      player.onended = () => {
        const currentIndex = book.links.indexOf(player.src);
        if (currentIndex + 1 < book.links.length) {
          player.src = book.links[currentIndex + 1];
          player.play();
        }
      };
    }

    searchInput.addEventListener("input", () => {
      renderBookList(searchInput.value);
    });
  </script>
</body>
</html>
